pipeline {
    agent any
    
    environment {
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–∑ —Ñ–∞–π–ª–∞ .env —á–µ—Ä–µ–∑ credentials
        ENV_FILE = credentials('monitoring-env-file')
        
        // –ò–ª–∏ –æ—Ç–¥–µ–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ (–∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Å–ø–æ—Å–æ–±)
        GRAFANA_PASS = credentials('grafana-admin-pass')
        CERTBOT_EMAIL = credentials('certbot-email')
        
        // –î–æ–º–µ–Ω—ã
        DOMAIN_PROM = 'prom.amateusfox.online'
        DOMAIN_GRAFANA = 'grafana.amateusfox.online'
        
        // IP-–∞–¥—Ä–µ—Å–∞
        CONTROL_VM_IP = '95.163.226.71'
        MONITORING_VM_IP = '194.67.124.52'
    }
    
    stages {
        stage('Checkout') {
            steps {
                cleanWs()
                checkout scm
                sh 'ls -la'
            }
        }
        
        stage('Load Environment Variables') {
            steps {
                // –°–ø–æ—Å–æ–± 1: –ò–∑ —Ñ–∞–π–ª–∞ .env (–µ—Å–ª–∏ –∑–∞–≥—Ä—É–∂–µ–Ω –∫–∞–∫ secret file)
                script {
                    if (fileExists("${ENV_FILE}")) {
                        def lines = readFile("${ENV_FILE}").split('\n')
                        lines.each { line ->
                            line = line.trim()
                            if (line && !line.startsWith('#')) {
                                def parts = line.split('=', 2)
                                if (parts.size() == 2) {
                                    env[parts[0].trim()] = parts[1].trim()
                                }
                            }
                        }
                    }
                }
                
                // –í—ã–≤–æ–¥–∏–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ (–±–µ–∑ –ø–∞—Ä–æ–ª–µ–π)
                sh '''
                    echo "=== Environment Variables ==="
                    echo "DOMAIN_PROM: ${DOMAIN_PROM}"
                    echo "DOMAIN_GRAFANA: ${DOMAIN_GRAFANA}"
                    echo "CONTROL_VM_IP: ${CONTROL_VM_IP}"
                    echo "MONITORING_VM_IP: ${MONITORING_VM_IP}"
                '''
            }
        }
        
        stage('Prepare Ansible Environment') {
            steps {
                // –ö–æ–ø–∏—Ä—É–µ–º SSH –∫–ª—é—á –∏–∑ Jenkins credentials
                withCredentials([file(credentialsId: 'ansible-ssh-key', variable: 'SSH_KEY')]) {
                    sh '''
                        mkdir -p ~/.ssh
                        cp "${SSH_KEY}" ~/.ssh/id_ansible_ed25519
                        chmod 600 ~/.ssh/id_ansible_ed25519
                    '''
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º inventory.ini —Å –∞–∫—Ç—É–∞–ª—å–Ω—ã–º–∏ IP
                sh '''
                    cat > inventory.ini << EOF
[monitoring]
monitoring-vm ansible_host=${MONITORING_VM_IP} ansible_user=devops ansible_ssh_private_key_file=~/.ssh/id_ansible_ed25519 ansible_ssh_common_args='-o StrictHostKeyChecking=no'

[control]
control-vm ansible_host=${CONTROL_VM_IP} ansible_user=devops ansible_ssh_private_key_file=~/.ssh/id_ansible_ed25519 ansible_ssh_common_args='-o StrictHostKeyChecking=no'

[all:children]
monitoring
control
EOF
                    
                    echo "=== Generated inventory.ini ==="
                    cat inventory.ini
                '''
                
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Ansible –µ—Å–ª–∏ –Ω–µ—Ç
                sh '''
                    if ! command -v ansible &> /dev/null; then
                        sudo apt-get update
                        sudo apt-get install -y ansible python3-pip
                        pip3 install docker
                    fi
                '''
            }
        }
        
        stage('Deploy with Ansible') {
            steps {
                script {
                    // –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è Ansible
                    env.ANSIBLE_HOST_KEY_CHECKING = "False"
                    env.DOMAIN_PROM = DOMAIN_PROM
                    env.DOMAIN_GRAFANA = DOMAIN_GRAFANA
                    env.CERTBOT_EMAIL = CERTBOT_EMAIL
                    env.CONTROL_VM_IP = CONTROL_VM_IP
                    env.GRAFANA_ADMIN_PASSWORD = GRAFANA_PASS
                }
                
                sh '''
                    echo "=== Running Ansible Playbook ==="
                    ansible-playbook -i inventory.ini playbook.yml -vv
                    
                    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
                    if [ $? -eq 0 ]; then
                        echo "Ansible playbook completed successfully"
                    else
                        echo "Ansible playbook failed"
                        exit 1
                    fi
                '''
            }
        }
        
        stage('Health Checks') {
            steps {
                // –î–∞–µ–º –≤—Ä–µ–º—è –Ω–∞ –∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–æ–≤
                sleep 30
                
                // 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ Prometheus
                sh '''
                    echo "=== Checking Prometheus ==="
                    # –ü—Ä–æ–≤–µ—Ä–∫–∞ health endpoint
                    curl -f -L --retry 3 --max-time 30 https://${DOMAIN_PROM}/-/healthy
                    echo "Prometheus health check: OK"
                    
                    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ UI
                    STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://${DOMAIN_PROM}/graph)
                    if [ "$STATUS" -eq 200 ]; then
                        echo "Prometheus UI is accessible (HTTP 200)"
                    else
                        echo "ERROR: Prometheus UI returned HTTP $STATUS"
                        exit 1
                    fi
                '''
                
                // 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ Grafana
                sh '''
                    echo "=== Checking Grafana ==="
                    # –ü—Ä–æ–≤–µ—Ä–∫–∞ health endpoint
                    curl -f -L --retry 3 --max-time 30 https://${DOMAIN_GRAFANA}/api/health
                    echo "Grafana health check: OK"
                    
                    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ UI
                    STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://${DOMAIN_GRAFANA}/login)
                    if [ "$STATUS" -eq 200 ]; then
                        echo "Grafana UI is accessible (HTTP 200)"
                    else
                        echo "ERROR: Grafana UI returned HTTP $STATUS"
                        exit 1
                    fi
                '''
                
                // 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤
                sh '''
                    echo "=== Checking SSL Certificates ==="
                    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ä–æ–∫–∞ –¥–µ–π—Å—Ç–≤–∏—è
                    for DOMAIN in ${DOMAIN_PROM} ${DOMAIN_GRAFANA}; do
                        echo "Checking certificate for $DOMAIN"
                        EXPIRY=$(openssl s_client -connect "$DOMAIN":443 -servername "$DOMAIN" < /dev/null 2>/dev/null | openssl x509 -noout -enddate | cut -d= -f2)
                        echo "Certificate expires on: $EXPIRY"
                        
                        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è –±–æ–ª—å—à–µ 7 –¥–Ω–µ–π
                        openssl s_client -connect "$DOMAIN":443 -servername "$DOMAIN" < /dev/null 2>/dev/null | openssl x509 -noout -checkend 604800
                        if [ $? -eq 0 ]; then
                            echo "Certificate is valid for at least 7 more days"
                        else
                            echo "WARNING: Certificate expires soon or is invalid"
                        fi
                    done
                '''
                
                // 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–µ—Ç—Ä–∏–∫ Node Exporter - –£–ü–†–û–©–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø
                sh '''
                    echo "=== Checking Node Exporter Metrics ==="
                    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –º–µ—Ç—Ä–∏–∫–∏ —Å control-vm (—É–ø—Ä–æ—â–µ–Ω–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç)
                    echo "Testing metrics endpoint..."
                    
                    # –°–ø–æ—Å–æ–± 1: –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å endpoint
                    if curl -s -f -L --max-time 30 "https://${DOMAIN_PROM}/api/v1/query?query=up{job=\\"node_exporter_control\\"}" > /tmp/metrics.json; then
                        echo "Metrics endpoint is accessible"
                        
                        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –µ—Å—Ç—å –∫–∞–∫–∏–µ-—Ç–æ –¥–∞–Ω–Ω—ã–µ
                        if grep -q "result" /tmp/metrics.json; then
                            echo "Metrics data found in response"
                            
                            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –Ω–µ –ø—É—Å—Ç–æ–π
                            if grep -q '"result":\[\]' /tmp/metrics.json; then
                                echo "WARNING: Empty result array - no metrics found"
                            else
                                echo "SUCCESS: Node Exporter metrics are available"
                            fi
                        else
                            echo "ERROR: Invalid response format"
                            cat /tmp/metrics.json
                            exit 1
                        fi
                    else
                        echo "ERROR: Failed to query metrics"
                        exit 1
                    fi
                    
                    # –ü—Ä–æ–≤–µ—Ä—è–µ–º raw metrics
                    echo "Checking raw metrics..."
                    curl -s https://${DOMAIN_PROM}/metrics | grep -E "node_cpu|node_memory|node_filesystem" | head -3
                '''
                
                // 5. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
                sh '''
                    echo "=== Checking Docker Containers ==="
                    ssh -i ~/.ssh/id_ansible_ed25519 -o StrictHostKeyChecking=no devops@${MONITORING_VM_IP} "
                        echo 'Containers status:'
                        docker ps --format 'table {{.Names}} {{.Status}} {{.Ports}}'
                        
                        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤—Å–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã —Ä–∞–±–æ—Ç–∞—é—Ç
                        RUNNING=\$(docker ps -q | wc -l)
                        echo "Running containers: \$RUNNING"
                        
                        if [ \$RUNNING -lt 3 ]; then
                            echo 'ERROR: Not all containers are running'
                            exit 1
                        fi
                    "
                '''
            }
        }
        
        stage('Smoke Tests') {
            steps {
                sh '''
                    echo "=== Running Smoke Tests ==="
                    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ Prometheus —Å–æ–±–∏—Ä–∞–µ—Ç –º–µ—Ç—Ä–∏–∫–∏
                    QUERY="count(up)"
                    RESULT=$(curl -s "https://${DOMAIN_PROM}/api/v1/query?query=$QUERY")
                    echo "Query result sample:"
                    echo "$RESULT" | head -20
                    
                    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ Nginx –ø—Ä–æ–∫—Å–∏—Ä—É–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ
                    echo "Testing Nginx proxy..."
                    curl -I https://${DOMAIN_PROM} 2>/dev/null | grep -E "HTTP|Location|Server" | head -3
                    curl -I https://${DOMAIN_GRAFANA} 2>/dev/null | grep -E "HTTP|Location|Server" | head -3
                '''
            }
        }
    }
    
    post {
        success {
            echo 'üöÄ Deployment successful! All checks passed.'
            sh '''
                echo "=== Summary ==="
                echo "Prometheus: https://${DOMAIN_PROM}"
                echo "Grafana: https://${DOMAIN_GRAFANA}"
                echo "Grafana admin password is stored in Jenkins credentials"
            '''
        }
        failure {
            echo '‚ùå Deployment failed! Check the logs above.'
            // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        }
        always {
            // –û—á–∏—Å—Ç–∫–∞
            sh '''
                rm -f ~/.ssh/id_ansible_ed25519
                rm -f /tmp/metrics.json 2>/dev/null || true
                echo "Cleanup completed"
            '''
        }
    }
}
