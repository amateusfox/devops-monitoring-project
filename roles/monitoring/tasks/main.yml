---
- name: Set node_exporter version
  set_fact:
    node_exporter_version: "1.8.2"

- name: Install Docker (if not present)
  block:
    - name: Install dependencies for Docker
      apt:
        name:
          - ca-certificates
          - curl
          - gnupg
          - lsb-release
        state: present
        update_cache: yes

    - name: Add Docker GPG key
      apt_key:
        url: https://download.docker.com/linux/ubuntu/gpg
        state: present

    - name: Add Docker repository
      apt_repository:
        repo: "deb [arch=amd64] https://download.docker.com/linux/ubuntu {{ ansible_distribution_release }} stable"
        state: present
        update_cache: yes

    - name: Install Docker packages
      apt:
        name:
          - docker-ce
          - docker-ce-cli
          - containerd.io
          - docker-compose-plugin
        state: present
        update_cache: yes

    - name: Add user to docker group
      user:
        name: devops
        groups: docker
        append: yes

- name: Install Node Exporter on all hosts
  block:
    - name: Create node_exporter user
      user:
        name: node_exporter
        system: yes
        shell: /usr/sbin/nologin

- name: Download and install Node Exporter
  unarchive:
        src: "https://github.com/prometheus/node_exporter/releases/download/v{{ node_exporter_version }}/node_exporter-{{ node_exporter_version }}.linux-amd64.tar.gz"
        dest: /tmp
        remote_src: yes
        validate_certs: no

- name: Copy binary
  copy:
        src: /tmp/node_exporter-{{ node_exporter_version }}.linux-amd64/node_exporter
        dest: /usr/local/bin/node_exporter
        mode: '0755'
        remote_src: yes

- name: Create systemd service
  template:
        src: node_exporter.service.j2  # добавим шаблон ниже
        dest: /etc/systemd/system/node_exporter.service
  notify: Restart node_exporter

- name: Enable and start Node Exporter
  systemd:
        name: node_exporter
        enabled: yes
        state: started
        daemon_reload: yes

- name: Deploy monitoring stack on monitoring-vm only
  block:
    - name: Create directory for stack
      file:
        path: /opt/monitoring
        state: directory
        mode: '0755'

    - name: Create directory for Prometheus rules
      file:
        path: /opt/monitoring/prometheus/rules
        state: directory
        mode: '0755'
      when: inventory_hostname in groups['monitoring']
    - name: Create directory for Alertmanager config
      file:
        path: /opt/monitoring/alertmanager
        state: directory
        mode: '0755'
      when: inventory_hostname in groups['monitoring']

    - name: Copy alerting rules
      copy:
        src: "{{ item }}"
        dest: /opt/monitoring/prometheus/rules/
      loop:
        - "{{ playbook_dir }}/roles/monitoring/files/rules/node_alerts.yml"
      when: inventory_hostname in groups['monitoring']
      notify: Restart monitoring stack

    - name: Create directory for Alertmanager config
      file:
        path: /opt/monitoring/alertmanager
        state: directory
        mode: '0755'
      when: inventory_hostname in groups['monitoring']

    - name: Copy Alertmanager configuration
      copy:
        src: "{{ playbook_dir }}/roles/monitoring/files/alertmanager/"
        dest: /opt/monitoring/alertmanager/
        directory_mode: yes
      when: inventory_hostname in groups['monitoring']
      notify: Restart monitoring stack

    - name: Template docker-compose.yml
      template:
        src: docker-compose.yml.j2
        dest: /opt/monitoring/docker-compose.yml
      notify: Restart monitoring stack

    - name: Template prometheus.yml
      template:
        src: prometheus.yml.j2
        dest: /opt/monitoring/prometheus.yml
      notify: Restart monitoring stack

    - name: Install pip3 (required for Python packages)
      apt:
        name: python3-pip
        state: present
      become: yes

    - name: Install Docker Compose Plugin (CLI v2)
      apt:
        name: docker-compose-plugin
        state: present
        update_cache: yes

    - name: Start docker-compose stack (v2)
      community.docker.docker_compose_v2:
        project_src: /opt/monitoring
        state: present
        remove_orphans: yes
        recreate: always

    - name: Install Nginx and Certbot
      apt:
        name:
          - nginx
          - certbot
          - python3-certbot-nginx
        state: present

    - name: Template Nginx config
      template:
        src: nginx.conf.j2
        dest: /etc/nginx/sites-available/monitoring
      notify: Reload Nginx

    - name: Enable Nginx site
      file:
        src: /etc/nginx/sites-available/monitoring
        dest: /etc/nginx/sites-enabled/monitoring
        state: link
      notify: Reload Nginx

    - name: Remove default Nginx site
      file:
        path: /etc/nginx/sites-enabled/default
        state: absent
      notify: Reload Nginx

    - name: Stop Nginx temporarily for certificate issuance
      service:
        name: nginx
        state: stopped
      become: yes

    - name: Obtain SSL certificates (standalone mode)
      command: >
        certbot certonly
        --standalone
        --preferred-challenges http
        -d {{ domain_prom }}
        -d {{ domain_grafana }}
        --non-interactive
        --agree-tos
        -m {{ certbot_email }}
      args:
        creates: /etc/letsencrypt/live/{{ domain_prom }}/fullchain.pem
      become: yes

    - name: Start Nginx back
      service:
        name: nginx
        state: started
      become: yes

    - name: Configure Nginx with obtained certificates
      command: >
        certbot --nginx
        -d {{ domain_prom }}
        -d {{ domain_grafana }}
        --non-interactive
        --agree-tos
        -m {{ certbot_email }}
        --redirect
      notify: Reload Nginx


  when: inventory_hostname in groups['monitoring']
  vars:
    domain_prom: "{{ lookup('env', 'DOMAIN_PROM') or 'prom.amateusfox.online' }}"
    domain_grafana: "{{ lookup('env', 'DOMAIN_GRAFANA') or 'grafana.amateusfox.online' }}"
    certbot_email: "{{ lookup('env', 'CERTBOT_EMAIL') or 'admin@amateusfox.online' }}"
